# httpsok系统复刻版 - 系统架构设计文档

## 1. 系统概述

本文档描述了基于Go语言和MySQL技术栈的httpsok系统复刻版的架构设计。httpsok是一个便捷的HTTPS证书自动续期工具，专为Nginx、OpenResty等服务器设计，提供一行命令完成SSL证书自动续签的功能。

### 1.1 系统目标

- 复刻httpsok的全部核心功能
- 使用Go语言重构后端服务
- 使用MySQL作为数据存储
- 保持原系统的易用性和高效性
- 提供良好的扩展性和可维护性

### 1.2 核心功能

根据对原httpsok系统的分析，复刻版需要实现以下核心功能：

1. **一键安装与配置**：通过一行命令完成客户端安装和配置
2. **自动检测**：自动识别Nginx证书配置，无需手动配置
3. **多域名支持**：支持泛解析、多域名、多服务器场景
4. **证书监控**：监控证书有效期，提供到期提醒
5. **自动续期**：自动为即将到期的证书申请续期
6. **多平台兼容**：兼容主流Linux系统（Debian、CentOS、Ubuntu等）
7. **手动申请**：支持手动申请证书，适用于CDN、OSS等场景
8. **Web管理界面**：提供证书管理、服务器管理、监控等功能

## 2. 系统架构

### 2.1 整体架构

系统采用前后端分离的微服务架构，主要包含以下组件：

```
+----------------------------------+
|          Web前端界面             |
+----------------------------------+
              |
+----------------------------------+
|          API网关层               |
+----------------------------------+
              |
+-------------------------------+
|          Go后端服务           |
|-------------------------------|
| - 用户认证服务                |
| - 证书管理服务                |
| - 服务器管理服务              |
| - 监控告警服务                |
| - 任务调度服务                |
+-------------------------------+
              |
+-------------------------------+
|          数据存储层           |
|-------------------------------|
| - MySQL数据库                 |
| - 文件存储                    |
+-------------------------------+
              |
+-------------------------------+
|          客户端组件           |
|-------------------------------|
| - 安装脚本                    |
| - 证书检测模块                |
| - 证书部署模块                |
| - 服务重载模块                |
+-------------------------------+
```

### 2.2 技术栈选择

#### 2.2.1 后端技术栈

- **编程语言**：Go 1.20+
- **Web框架**：Gin/Echo
- **ORM框架**：GORM
- **数据库**：MySQL 8.0+
- **缓存**：Redis (可选)
- **消息队列**：RabbitMQ/Kafka (可选，用于异步任务)
- **认证**：JWT
- **API文档**：Swagger
- **日志**：zap
- **配置管理**：viper
- **依赖注入**：wire/dig

#### 2.2.2 前端技术栈

- **框架**：React/Vue
- **UI组件库**：Ant Design/Element UI
- **状态管理**：Redux/Vuex
- **路由**：React Router/Vue Router
- **HTTP客户端**：Axios
- **构建工具**：Webpack/Vite

#### 2.2.3 客户端技术栈

- **脚本语言**：Bash
- **证书工具**：acme.sh (集成)
- **Web服务器**：Nginx/Apache (支持)

### 2.3 系统组件

#### 2.3.1 API网关

- 请求路由和负载均衡
- 认证和授权
- 请求限流和熔断
- API版本管理
- 跨域资源共享(CORS)

#### 2.3.2 用户认证服务

- 用户注册和登录
- 令牌管理
- 权限控制
- 用户信息管理

#### 2.3.3 证书管理服务

- 证书申请
- 证书续期
- 证书查询和管理
- DNS验证
- 证书部署

#### 2.3.4 服务器管理服务

- 服务器注册和管理
- 服务器状态监控
- 配置管理
- 服务重载

#### 2.3.5 监控告警服务

- 证书有效期监控
- 服务器状态监控
- 告警规则管理
- 通知渠道管理

#### 2.3.6 任务调度服务

- 定时任务管理
- 异步任务处理
- 任务状态跟踪
- 失败重试机制

#### 2.3.7 客户端组件

- 安装脚本
- 证书检测模块
- 证书部署模块
- 服务重载模块
- 与服务端通信模块

## 3. 功能模块设计

### 3.1 用户管理模块

#### 3.1.1 功能描述

- 用户注册和登录
- 用户信息管理
- 权限管理
- 令牌管理

#### 3.1.2 API接口

- `POST /api/v1/auth/register`：用户注册
- `POST /api/v1/auth/login`：用户登录
- `GET /api/v1/auth/profile`：获取用户信息
- `PUT /api/v1/auth/profile`：更新用户信息
- `POST /api/v1/auth/refresh`：刷新令牌

### 3.2 服务器管理模块

#### 3.2.1 功能描述

- 服务器添加和管理
- 服务器状态监控
- 服务器配置管理
- 服务器分组管理

#### 3.2.2 API接口

- `POST /api/v1/servers`：添加服务器
- `GET /api/v1/servers`：获取服务器列表
- `GET /api/v1/servers/{id}`：获取服务器详情
- `PUT /api/v1/servers/{id}`：更新服务器信息
- `DELETE /api/v1/servers/{id}`：删除服务器
- `GET /api/v1/servers/{id}/status`：获取服务器状态
- `POST /api/v1/servers/{id}/reload`：重载服务器配置

### 3.3 证书管理模块

#### 3.3.1 功能描述

- 证书申请
- 证书续期
- 证书查询和管理
- DNS验证
- 证书部署

#### 3.3.2 API接口

- `POST /api/v1/certificates`：申请证书
- `GET /api/v1/certificates`：获取证书列表
- `GET /api/v1/certificates/{id}`：获取证书详情
- `PUT /api/v1/certificates/{id}`：更新证书信息
- `DELETE /api/v1/certificates/{id}`：删除证书
- `POST /api/v1/certificates/{id}/renew`：续期证书
- `POST /api/v1/certificates/{id}/deploy`：部署证书
- `GET /api/v1/certificates/{id}/status`：获取证书状态

### 3.4 监控告警模块

#### 3.4.1 功能描述

- 证书有效期监控
- 服务器状态监控
- 告警规则管理
- 通知渠道管理

#### 3.4.2 API接口

- `GET /api/v1/monitors`：获取监控列表
- `POST /api/v1/monitors`：创建监控
- `GET /api/v1/monitors/{id}`：获取监控详情
- `PUT /api/v1/monitors/{id}`：更新监控信息
- `DELETE /api/v1/monitors/{id}`：删除监控
- `GET /api/v1/alerts`：获取告警列表
- `POST /api/v1/alerts`：创建告警规则
- `GET /api/v1/alerts/{id}`：获取告警规则详情
- `PUT /api/v1/alerts/{id}`：更新告警规则
- `DELETE /api/v1/alerts/{id}`：删除告警规则

### 3.5 任务调度模块

#### 3.5.1 功能描述

- 定时任务管理
- 异步任务处理
- 任务状态跟踪
- 失败重试机制

#### 3.5.2 API接口

- `GET /api/v1/tasks`：获取任务列表
- `POST /api/v1/tasks`：创建任务
- `GET /api/v1/tasks/{id}`：获取任务详情
- `PUT /api/v1/tasks/{id}`：更新任务信息
- `DELETE /api/v1/tasks/{id}`：删除任务
- `POST /api/v1/tasks/{id}/execute`：执行任务
- `GET /api/v1/tasks/{id}/status`：获取任务状态

### 3.6 客户端模块

#### 3.6.1 功能描述

- 安装和配置
- 证书检测
- 证书部署
- 服务重载
- 与服务端通信

#### 3.6.2 命令行接口

- `httpsok install`：安装客户端
- `httpsok config`：配置客户端
- `httpsok scan`：扫描证书
- `httpsok renew`：续期证书
- `httpsok deploy`：部署证书
- `httpsok reload`：重载服务
- `httpsok status`：查看状态

## 4. 数据流程

### 4.1 证书申请流程

1. 用户通过Web界面或API发起证书申请请求
2. 系统验证请求参数
3. 系统生成DNS验证记录
4. 用户配置DNS记录
5. 系统验证DNS记录
6. 系统调用acme.sh申请证书
7. 系统保存证书信息
8. 系统返回申请结果

### 4.2 证书续期流程

1. 系统定时检查证书有效期
2. 系统识别即将到期的证书
3. 系统自动触发续期流程
4. 系统调用acme.sh续期证书
5. 系统更新证书信息
6. 系统部署新证书
7. 系统重载Web服务器
8. 系统发送续期结果通知

### 4.3 证书部署流程

1. 系统接收部署请求
2. 系统验证证书状态
3. 系统生成部署任务
4. 客户端执行部署任务
5. 客户端将证书文件部署到指定位置
6. 客户端重载Web服务器
7. 客户端返回部署结果
8. 系统更新部署状态

## 5. 安全设计

### 5.1 认证与授权

- 基于JWT的认证机制
- 基于角色的访问控制(RBAC)
- API密钥认证
- 客户端令牌认证

### 5.2 数据安全

- 敏感数据加密存储
- 传输层安全(TLS)
- 证书私钥安全管理
- 数据备份和恢复

### 5.3 API安全

- 请求限流
- 输入验证和过滤
- CSRF防护
- 安全头部配置

## 6. 扩展性设计

### 6.1 模块化设计

- 松耦合的服务组件
- 插件化架构
- 标准化接口

### 6.2 水平扩展

- 无状态服务设计
- 负载均衡
- 数据库读写分离
- 缓存策略

### 6.3 垂直扩展

- 资源优化
- 性能调优
- 异步处理

## 7. 部署架构

### 7.1 开发环境

- 本地开发环境
- Docker容器化开发
- 测试数据库

### 7.2 测试环境

- 集成测试环境
- 性能测试环境
- 模拟生产环境

### 7.3 生产环境

- 高可用部署
- 容器化部署
- 监控和告警
- 备份和恢复

## 8. 技术挑战与解决方案

### 8.1 自动检测Nginx配置

**挑战**：需要准确解析不同格式和版本的Nginx配置文件

**解决方案**：
- 开发强大的配置解析器
- 支持多种配置格式和版本
- 使用正则表达式和AST解析
- 提供配置验证机制

### 8.2 多域名和通配符证书支持

**挑战**：需要处理复杂的域名配置和验证

**解决方案**：
- 设计灵活的域名管理模型
- 支持多种DNS验证方式
- 优化DNS验证流程
- 提供批量操作接口

### 8.3 高并发证书操作

**挑战**：大量证书同时续期可能导致性能问题

**解决方案**：
- 任务队列和异步处理
- 批处理优化
- 资源限制和优先级
- 分布式处理

### 8.4 多平台兼容性

**挑战**：需要支持不同的Linux发行版和Web服务器

**解决方案**：
- 抽象平台差异
- 适配层设计
- 兼容性测试
- 配置模板

## 9. 性能考量

### 9.1 数据库优化

- 索引设计
- 查询优化
- 连接池管理
- 分表分库策略

### 9.2 缓存策略

- 多级缓存
- 缓存失效策略
- 热点数据处理
- 分布式缓存

### 9.3 并发处理

- 协程池
- 连接池
- 任务队列
- 限流机制

## 10. 监控与运维

### 10.1 系统监控

- 服务健康检查
- 性能指标收集
- 资源使用监控
- 异常检测

### 10.2 日志管理

- 结构化日志
- 日志级别控制
- 日志轮转
- 集中式日志收集

### 10.3 告警机制

- 告警规则配置
- 多渠道通知
- 告警聚合
- 告警升级

## 11. 未来扩展

### 11.1 功能扩展

- 支持更多证书提供商
- 支持更多Web服务器
- 高级证书管理功能
- 更多部署场景支持

### 11.2 技术扩展

- 微服务架构演进
- 容器编排集成
- 云原生支持
- AI辅助运维

### 11.3 生态集成

- 云服务商集成
- DevOps工具链集成
- 监控系统集成
- 安全扫描集成
