# 后端开发需求文档 - httpsok系统复刻版（Go+MySQL）

## 1. 概述

本文档详细描述了基于Go语言和MySQL技术栈的httpsok系统复刻版的后端开发需求。后端开发工程师负责实现系统的核心业务逻辑、API接口、数据库交互以及与客户端脚本的集成。系统采用微服务架构，使用Go语言作为主要开发语言，MySQL作为数据存储，旨在提供高效、可靠的SSL证书自动化管理解决方案。

## 2. 技术栈要求

### 2.1 编程语言与框架

- **主要语言**：Go 1.20+
- **Web框架**：Gin 1.9.0+（或Echo 4.10.0+）
- **ORM框架**：GORM 1.25.0+
- **配置管理**：Viper 1.15.0+
- **日志框架**：Zap 1.24.0+
- **依赖注入**：Wire 0.5.0+（或Dig 1.17.0+）

### 2.2 数据库与存储

- **关系型数据库**：MySQL 8.0+
- **迁移工具**：Goose/Flyway
- **缓存**：Redis 7.0+（可选）

### 2.3 中间件与工具

- **消息队列**：RabbitMQ/Kafka（可选，用于异步任务）
- **API文档**：Swagger/OpenAPI 3.0
- **认证**：JWT
- **加密**：bcrypt, AES-GCM
- **测试框架**：Go testing, testify

### 2.4 开发工具

- **版本控制**：Git
- **CI/CD**：GitHub Actions/GitLab CI
- **代码质量**：golangci-lint
- **容器化**：Docker, Docker Compose

## 3. 系统架构

后端系统采用微服务架构，主要包含以下服务组件：

### 3.1 API网关服务

- 请求路由和负载均衡
- 认证和授权
- 请求限流和熔断
- API版本管理
- 跨域资源共享(CORS)

### 3.2 用户认证服务

- 用户注册和登录
- 令牌管理
- 权限控制
- 用户信息管理

### 3.3 证书管理服务

- 证书申请
- 证书续期
- 证书查询和管理
- DNS验证
- 证书部署

### 3.4 服务器管理服务

- 服务器注册和管理
- 服务器状态监控
- 配置管理
- 服务重载

### 3.5 监控告警服务

- 证书有效期监控
- 服务器状态监控
- 告警规则管理
- 通知渠道管理

### 3.6 任务调度服务

- 定时任务管理
- 异步任务处理
- 任务状态跟踪
- 失败重试机制

## 4. 数据库设计

后端开发需要实现与数据库的交互，包括但不限于以下表的CRUD操作：

### 4.1 核心数据表

- **users**：用户信息表
- **api_keys**：API密钥表
- **user_tokens**：用户令牌表
- **servers**：服务器信息表
- **server_configs**：服务器配置表
- **certificates**：证书信息表
- **certificate_deployments**：证书部署表
- **dns_challenges**：DNS挑战记录表
- **monitors**：监控配置表
- **alerts**：告警规则表
- **alert_channels**：告警通道表
- **tasks**：任务信息表

### 4.2 数据访问层

- 使用GORM实现数据模型和ORM映射
- 实现数据库事务管理
- 实现数据库连接池管理
- 实现数据库迁移和版本控制

## 5. API接口设计

### 5.1 RESTful API规范

- 使用标准HTTP方法（GET, POST, PUT, DELETE）
- 使用JSON作为数据交换格式
- 使用标准HTTP状态码
- 实现API版本控制
- 提供详细的错误信息

### 5.2 认证与授权API

#### 5.2.1 用户认证

- `POST /api/v1/auth/register`：用户注册
  - 请求参数：用户名、邮箱、密码、全名（可选）、电话（可选）
  - 响应：用户信息、访问令牌

- `POST /api/v1/auth/login`：用户登录
  - 请求参数：用户名/邮箱、密码
  - 响应：用户信息、访问令牌、刷新令牌

- `POST /api/v1/auth/refresh`：刷新令牌
  - 请求参数：刷新令牌
  - 响应：新的访问令牌

- `POST /api/v1/auth/logout`：用户登出
  - 请求参数：无
  - 响应：成功状态

#### 5.2.2 用户管理

- `GET /api/v1/users/me`：获取当前用户信息
  - 请求参数：无
  - 响应：用户详细信息

- `PUT /api/v1/users/me`：更新当前用户信息
  - 请求参数：用户信息字段
  - 响应：更新后的用户信息

- `PUT /api/v1/users/me/password`：修改密码
  - 请求参数：旧密码、新密码
  - 响应：成功状态

#### 5.2.3 API密钥管理

- `GET /api/v1/api-keys`：获取API密钥列表
  - 请求参数：分页参数
  - 响应：API密钥列表

- `POST /api/v1/api-keys`：创建API密钥
  - 请求参数：密钥名称、过期时间（可选）
  - 响应：API密钥信息

- `DELETE /api/v1/api-keys/{id}`：删除API密钥
  - 请求参数：无
  - 响应：成功状态

### 5.3 服务器管理API

#### 5.3.1 服务器CRUD

- `GET /api/v1/servers`：获取服务器列表
  - 请求参数：分页参数、过滤条件
  - 响应：服务器列表

- `POST /api/v1/servers`：添加服务器
  - 请求参数：服务器信息（名称、主机名、端口、类型等）
  - 响应：服务器信息

- `GET /api/v1/servers/{id}`：获取服务器详情
  - 请求参数：无
  - 响应：服务器详细信息

- `PUT /api/v1/servers/{id}`：更新服务器信息
  - 请求参数：服务器信息字段
  - 响应：更新后的服务器信息

- `DELETE /api/v1/servers/{id}`：删除服务器
  - 请求参数：无
  - 响应：成功状态

#### 5.3.2 服务器操作

- `POST /api/v1/servers/{id}/scan`：扫描服务器证书
  - 请求参数：扫描选项
  - 响应：扫描结果

- `POST /api/v1/servers/{id}/reload`：重载服务器配置
  - 请求参数：无
  - 响应：重载结果

- `GET /api/v1/servers/{id}/status`：获取服务器状态
  - 请求参数：无
  - 响应：服务器状态信息

#### 5.3.3 服务器分组

- `GET /api/v1/server-groups`：获取服务器组列表
  - 请求参数：分页参数
  - 响应：服务器组列表

- `POST /api/v1/server-groups`：创建服务器组
  - 请求参数：组名称、描述
  - 响应：服务器组信息

- `PUT /api/v1/server-groups/{id}`：更新服务器组
  - 请求参数：组信息字段
  - 响应：更新后的服务器组信息

- `DELETE /api/v1/server-groups/{id}`：删除服务器组
  - 请求参数：无
  - 响应：成功状态

- `POST /api/v1/server-groups/{id}/servers`：添加服务器到组
  - 请求参数：服务器ID列表
  - 响应：成功状态

- `DELETE /api/v1/server-groups/{id}/servers/{serverId}`：从组中移除服务器
  - 请求参数：无
  - 响应：成功状态

### 5.4 证书管理API

#### 5.4.1 证书CRUD

- `GET /api/v1/certificates`：获取证书列表
  - 请求参数：分页参数、过滤条件
  - 响应：证书列表

- `POST /api/v1/certificates`：申请证书
  - 请求参数：域名列表、证书类型、加密类型、备注等
  - 响应：证书申请信息和DNS验证记录

- `GET /api/v1/certificates/{id}`：获取证书详情
  - 请求参数：无
  - 响应：证书详细信息

- `PUT /api/v1/certificates/{id}`：更新证书信息
  - 请求参数：证书信息字段
  - 响应：更新后的证书信息

- `DELETE /api/v1/certificates/{id}`：删除证书
  - 请求参数：无
  - 响应：成功状态

#### 5.4.2 证书操作

- `POST /api/v1/certificates/{id}/verify`：验证DNS记录
  - 请求参数：无
  - 响应：验证结果

- `POST /api/v1/certificates/{id}/issue`：颁发证书
  - 请求参数：无
  - 响应：颁发结果

- `POST /api/v1/certificates/{id}/renew`：续期证书
  - 请求参数：无
  - 响应：续期结果

- `GET /api/v1/certificates/{id}/download`：下载证书
  - 请求参数：格式（可选）
  - 响应：证书文件

#### 5.4.3 证书部署

- `GET /api/v1/certificates/{id}/deployments`：获取证书部署列表
  - 请求参数：分页参数
  - 响应：部署列表

- `POST /api/v1/certificates/{id}/deployments`：创建证书部署
  - 请求参数：服务器ID、部署路径、配置路径等
  - 响应：部署信息

- `DELETE /api/v1/certificates/{id}/deployments/{deploymentId}`：删除证书部署
  - 请求参数：无
  - 响应：成功状态

- `POST /api/v1/certificates/{id}/deployments/{deploymentId}/deploy`：执行部署
  - 请求参数：无
  - 响应：部署结果

### 5.5 监控告警API

#### 5.5.1 监控管理

- `GET /api/v1/monitors`：获取监控列表
  - 请求参数：分页参数、过滤条件
  - 响应：监控列表

- `POST /api/v1/monitors`：创建监控
  - 请求参数：监控类型、目标、检查间隔等
  - 响应：监控信息

- `GET /api/v1/monitors/{id}`：获取监控详情
  - 请求参数：无
  - 响应：监控详细信息

- `PUT /api/v1/monitors/{id}`：更新监控信息
  - 请求参数：监控信息字段
  - 响应：更新后的监控信息

- `DELETE /api/v1/monitors/{id}`：删除监控
  - 请求参数：无
  - 响应：成功状态

- `POST /api/v1/monitors/{id}/check`：执行监控检查
  - 请求参数：无
  - 响应：检查结果

#### 5.5.2 告警管理

- `GET /api/v1/alerts`：获取告警规则列表
  - 请求参数：分页参数、过滤条件
  - 响应：告警规则列表

- `POST /api/v1/alerts`：创建告警规则
  - 请求参数：告警类型、条件、严重程度等
  - 响应：告警规则信息

- `GET /api/v1/alerts/{id}`：获取告警规则详情
  - 请求参数：无
  - 响应：告警规则详细信息

- `PUT /api/v1/alerts/{id}`：更新告警规则
  - 请求参数：告警规则字段
  - 响应：更新后的告警规则信息

- `DELETE /api/v1/alerts/{id}`：删除告警规则
  - 请求参数：无
  - 响应：成功状态

#### 5.5.3 告警通道

- `GET /api/v1/alert-channels`：获取告警通道列表
  - 请求参数：分页参数
  - 响应：告警通道列表

- `POST /api/v1/alert-channels`：创建告警通道
  - 请求参数：通道类型、配置信息等
  - 响应：告警通道信息

- `GET /api/v1/alert-channels/{id}`：获取告警通道详情
  - 请求参数：无
  - 响应：告警通道详细信息

- `PUT /api/v1/alert-channels/{id}`：更新告警通道
  - 请求参数：通道信息字段
  - 响应：更新后的告警通道信息

- `DELETE /api/v1/alert-channels/{id}`：删除告警通道
  - 请求参数：无
  - 响应：成功状态

- `POST /api/v1/alert-channels/{id}/test`：测试告警通道
  - 请求参数：测试消息
  - 响应：测试结果

### 5.6 任务管理API

#### 5.6.1 任务CRUD

- `GET /api/v1/tasks`：获取任务列表
  - 请求参数：分页参数、过滤条件
  - 响应：任务列表

- `POST /api/v1/tasks`：创建任务
  - 请求参数：任务类型、参数、计划时间等
  - 响应：任务信息

- `GET /api/v1/tasks/{id}`：获取任务详情
  - 请求参数：无
  - 响应：任务详细信息

- `DELETE /api/v1/tasks/{id}`：删除任务
  - 请求参数：无
  - 响应：成功状态

#### 5.6.2 任务操作

- `POST /api/v1/tasks/{id}/execute`：执行任务
  - 请求参数：无
  - 响应：执行结果

- `POST /api/v1/tasks/{id}/cancel`：取消任务
  - 请求参数：无
  - 响应：成功状态

- `GET /api/v1/tasks/{id}/logs`：获取任务日志
  - 请求参数：分页参数
  - 响应：日志列表

#### 5.6.3 定时任务

- `GET /api/v1/scheduled-tasks`：获取定时任务列表
  - 请求参数：分页参数
  - 响应：定时任务列表

- `POST /api/v1/scheduled-tasks`：创建定时任务
  - 请求参数：任务名称、类型、Cron表达式等
  - 响应：定时任务信息

- `PUT /api/v1/scheduled-tasks/{id}`：更新定时任务
  - 请求参数：任务信息字段
  - 响应：更新后的定时任务信息

- `DELETE /api/v1/scheduled-tasks/{id}`：删除定时任务
  - 请求参数：无
  - 响应：成功状态

- `POST /api/v1/scheduled-tasks/{id}/toggle`：启用/禁用定时任务
  - 请求参数：状态
  - 响应：成功状态

### 5.7 系统管理API

#### 5.7.1 系统设置

- `GET /api/v1/settings`：获取系统设置
  - 请求参数：无
  - 响应：系统设置列表

- `PUT /api/v1/settings`：更新系统设置
  - 请求参数：设置键值对
  - 响应：更新后的设置

#### 5.7.2 用户设置

- `GET /api/v1/user-settings`：获取用户设置
  - 请求参数：无
  - 响应：用户设置列表

- `PUT /api/v1/user-settings`：更新用户设置
  - 请求参数：设置键值对
  - 响应：更新后的设置

#### 5.7.3 审计日志

- `GET /api/v1/audit-logs`：获取审计日志
  - 请求参数：分页参数、过滤条件
  - 响应：审计日志列表

## 6. 核心功能实现

### 6.1 acme.sh集成

#### 6.1.1 功能要求

- 封装acme.sh命令行工具
- 支持证书申请、续期和撤销
- 支持多种CA服务商（Let's Encrypt, ZeroSSL等）
- 支持多种验证方式（DNS-01, HTTP-01）
- 支持ECC和RSA加密算法

#### 6.1.2 实现方式

- 创建acme.sh命令包装器
- 实现命令执行和结果解析
- 实现错误处理和重试机制
- 实现并发控制和限流

### 6.2 证书自动续期

#### 6.2.1 功能要求

- 定期检查证书有效期
- 自动触发续期流程
- 支持批量续期
- 提供续期状态和结果通知

#### 6.2.2 实现方式

- 创建证书检查定时任务
- 实现续期任务队列
- 实现续期结果处理
- 实现通知机制

### 6.3 服务器配置检测

#### 6.3.1 功能要求

- 自动检测Nginx/Apache配置
- 识别证书路径和域名配置
- 支持复杂配置解析
- 提供配置验证

#### 6.3.2 实现方式

- 实现配置文件解析器
- 实现正则表达式匹配
- 实现配置验证逻辑
- 实现错误处理和报告

### 6.4 证书部署

#### 6.4.1 功能要求

- 自动部署证书到服务器
- 支持多种Web服务器（Nginx, Apache等）
- 自动备份原有证书
- 自动重载服务

#### 6.4.2 实现方式

- 实现SSH/SFTP客户端
- 实现证书文件传输
- 实现服务重载命令
- 实现部署结果验证

### 6.5 监控和告警

#### 6.5.1 功能要求

- 监控证书有效期
- 监控服务器状态
- 支持多种告警条件
- 支持多种通知渠道

#### 6.5.2 实现方式

- 实现监控检查逻辑
- 实现告警触发条件
- 实现通知发送逻辑
- 实现告警状态管理

## 7. 安全实现

### 7.1 认证与授权

#### 7.1.1 JWT认证

- 实现JWT令牌生成和验证
- 实现令牌刷新机制
- 实现令牌撤销机制
- 实现令牌过期处理

#### 7.1.2 权限控制

- 实现基于角色的访问控制(RBAC)
- 实现API权限检查中间件
- 实现资源所有权验证
- 实现权限缓存

### 7.2 数据安全

#### 7.2.1 敏感数据加密

- 实现密码哈希存储（bcrypt）
- 实现私钥加密存储（AES-GCM）
- 实现API密钥安全管理
- 实现数据传输加密（TLS）

#### 7.2.2 输入验证

- 实现请求参数验证
- 实现SQL注入防护
- 实现XSS防护
- 实现CSRF防护

### 7.3 API安全

#### 7.3.1 请求限流

- 实现基于IP的限流
- 实现基于用户的限流
- 实现基于API的限流
- 实现令牌桶算法

#### 7.3.2 安全头部

- 实现安全相关HTTP头部
- 实现CORS配置
- 实现内容安全策略
- 实现XSS保护头部

## 8. 性能优化

### 8.1 数据库优化

- 实现数据库连接池
- 实现查询优化
- 实现索引优化
- 实现事务管理

### 8.2 缓存策略

- 实现内存缓存
- 实现Redis缓存（可选）
- 实现缓存失效策略
- 实现缓存预热

### 8.3 并发处理

- 实现协程池
- 实现任务队列
- 实现并发控制
- 实现资源限制

## 9. 测试要求

### 9.1 单元测试

- 为所有核心功能编写单元测试
- 使用模拟对象和依赖注入
- 实现测试覆盖率报告
- 实现测试自动化

### 9.2 集成测试

- 实现API集成测试
- 实现数据库集成测试
- 实现第三方服务集成测试
- 实现端到端测试

### 9.3 性能测试

- 实现API性能测试
- 实现数据库性能测试
- 实现负载测试
- 实现基准测试

## 10. 部署与运维

### 10.1 容器化

- 提供Dockerfile
- 提供Docker Compose配置
- 实现多阶段构建
- 实现镜像优化

### 10.2 配置管理

- 实现环境变量配置
- 实现配置文件加载
- 实现配置热重载
- 实现配置验证

### 10.3 日志管理

- 实现结构化日志
- 实现日志级别控制
- 实现日志轮转
- 实现日志聚合

### 10.4 监控与告警

- 实现健康检查接口
- 实现性能指标收集
- 实现Prometheus集成
- 实现告警配置

## 11. 文档要求

### 11.1 代码文档

- 遵循Go文档规范
- 为所有导出函数和类型添加文档注释
- 提供示例代码
- 使用godoc生成文档

### 11.2 API文档

- 使用Swagger/OpenAPI规范
- 提供详细的API描述
- 提供请求和响应示例
- 提供错误码说明

### 11.3 开发文档

- 提供架构设计文档
- 提供数据库设计文档
- 提供开发环境搭建指南
- 提供贡献指南

## 12. 交付物

1. **源代码**：
   - 完整的Go源代码
   - 数据库迁移脚本
   - 配置文件模板

2. **文档**：
   - API文档（Swagger/OpenAPI）
   - 代码文档
   - 架构设计文档
   - 数据库设计文档

3. **测试**：
   - 单元测试
   - 集成测试
   - 性能测试脚本

4. **部署**：
   - Dockerfile
   - Docker Compose配置
   - 部署脚本

## 13. 开发流程与规范

### 13.1 代码规范

- 遵循Go官方代码规范
- 使用golangci-lint进行代码检查
- 遵循项目目录结构规范
- 使用统一的命名规范

### 13.2 版本控制

- 使用Git进行版本控制
- 遵循语义化版本规范
- 使用分支开发流程
- 使用合并请求进行代码审查

### 13.3 持续集成

- 配置CI/CD流水线
- 自动化测试和构建
- 自动化代码质量检查
- 自动化部署

### 13.4 项目管理

- 使用敏捷开发方法
- 定期进行代码审查
- 定期进行进度汇报
- 使用问题跟踪系统

## 14. 时间规划

| 阶段 | 时间 | 主要任务 |
|------|------|---------|
| 准备阶段 | 1周 | 环境搭建、技术选型、架构设计 |
| 基础开发 | 2周 | 数据库设计、基础框架搭建、认证系统实现 |
| 核心功能开发 | 4周 | 证书管理、服务器管理、监控告警实现 |
| 集成与测试 | 2周 | 系统集成、测试、性能优化 |
| 文档与部署 | 1周 | 文档编写、部署配置、交付准备 |

## 15. 风险与挑战

### 15.1 技术风险

- acme.sh集成复杂度
- Nginx配置解析难度
- 多平台兼容性问题
- 性能和并发处理

### 15.2 解决策略

- 提前进行技术验证
- 采用渐进式开发方法
- 建立完善的测试体系
- 定期进行代码审查和重构
